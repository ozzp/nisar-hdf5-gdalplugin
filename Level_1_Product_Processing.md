# NISAR GDAL Driver: Level 1 Product Processing

This document describes how the GDAL driver handles NISAR Level 1 (L1) products, such as `RSLC` (Range-Doppler Single Look Complex). Unlike Level 2 products which are already geocoded to a map projection, L1 products are provided in the sensor's native radar coordinates: **slant range** and **azimuth time**.

To make this data usable in standard GIS software, the driver's primary responsibility is to read the sensor metadata and generate a set of **Ground Control Points (GCPs)**. These GCPs map pixels in the radar-coordinate image to real-world geographic coordinates (longitude, latitude).

## The Geolocation Grid

The core of this process relies on the **Geolocation Grid** metadata stored within the HDF5 file. This is not a point for every pixel, but rather a sparse grid of reference points that span the radar image. The driver creates one GCP for each point in this grid.

## HDF5 Metadata for GCP Generation

The driver reads several specific datasets and attributes from the HDF5 file to perform the GCP calculation. The `<product_type>` placeholder (e.g., `RSLC`) is determined by the driver's product detection logic.

### 1\. Geolocation Grid Metadata

**Path**: `/science/LSAR/<product_type>/metadata/geolocationGrid/`

  * **`epsg`** (Dataset): A scalar integer representing the EPSG code of the geographic coordinates in the grid (e.g., `4326` for WGS 84).
  * **`coordinateX`**, **`coordinateY`** (3D Datasets): 3D cubes `(height, azimuth, range)` containing the longitude and latitude for each grid point. The driver reads a 2D slice at a fixed height (`index 0`).
  * **`zeroDopplerTime`** (1D Dataset): An array of azimuth time values for each row of the grid.
      * **`units`** (Attribute): A string that defines the time epoch for this array (e.g., `"seconds since 2008-10-12 00:00:00"`). **This is critical for correct time conversion.**
  * **`slantRange`** (1D Dataset): An array of slant range values for each column of the grid.

### 2\. Swath and Scene Metadata

These datasets provide the reference information for the full-resolution radar image.

  * **/science/LSAR/\<product\_type\>/swaths/frequencyA/\`**
      * **`slantRange`** (Dataset): A 1D array of slant range values for every pixel in the range direction. The **first value** of this array is used as the `startingRange` of the image.
      * **`slantRangeSpacing`** (Dataset): The distance in meters between each pixel in the range direction.
      * **`nominalAcquisitionPRF`** (Dataset): The Pulse Repetition Frequency (PRF) of the acquisition, used to convert azimuth time to image line numbers.
  * **/science/LSAR/identification/**
      * **`zeroDopplerStartTime`** (Dataset): The absolute UTC start time of the entire scene. This is the time reference for line `0` of the image.

## The GCP Calculation Process

For each point in the `azimuth_times` and `slant_ranges` grid arrays, the driver performs the following calculation:

1.  **Get Geographic Coordinate**: It retrieves the longitude and latitude from the `coordinateX` and `coordinateY` cubes. These become the `(X, Y)` of the GCP.
2.  **Calculate Pixel Coordinate**: It calculates the image pixel coordinate using the slant range values.
      * $GCP_{Pixel} = ((gridSlantRange - startingRange) / rangePixelSpacing) + 0.5$
3.  **Calculate Line Coordinate**: It calculates the image line coordinate by converting all time values to a common reference (Unix time).
      * First, the epoch from the `units` attribute is converted to a Unix timestamp (`time_epoch`).
      * The `scene_start_time` is also converted to a Unix timestamp.
      * $GCP_{UnixTime} = \text{time\_epoch} + \text{grid\_azimuth\_time}$
      * $GCP_{Line} = ((\text{GCP}_{UnixTime} - \text{scene\_start\_time}) \times PRF) + 0.5$
4.  **Set GCPs**: The final list of `(Pixel, Line) -> (Lon, Lat)` points is attached to the GDAL dataset, along with the EPSG code.

## Example Usage: Geocoding with `gdalwarp`

Once the driver has exposed the GCPs, you can use a tool like `gdalwarp` to create a geocoded GeoTIFF. The `-tps` (Thin Plate Spline) flag is recommended for the highest accuracy with a large number of GCPs.

```bash
gdalwarp \
    -overwrite \
    -t_srs EPSG:4326 \
    -tps \
    -r cubic \
    NISAR:"/path/to/NISAR_L1_RSLC.h5":/science/LSAR/RSLC/swaths/frequencyA/HH \
    output_geocoded.tif
```

This command reads the source RSLC file, uses the 14,144 GCPs generated by the driver, and warps the radar-coordinate image into a standard, map-ready `WGS 84` GeoTIFF.
